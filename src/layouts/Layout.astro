---
import Header from '../components/header.astro';
import Footer from '../components/footer.astro';
import '../global.css';

interface Props {
  title: string;
  maxWidth?: string;
  twoColumn?: boolean;
  floatingImages?: boolean;
  imageCount?: number;
  noWrapper?: boolean;
}

const { 
  title, 
  maxWidth = '1200px', 
  twoColumn = false,
  floatingImages = false,
  imageCount = 10,
  noWrapper = false
} = Astro.props;

// Floating images setup - use static list to avoid eager loading
let shuffledImages: string[] = [];
if (floatingImages) {
  // Predefined list to avoid loading all images eagerly
  // Using .optimized.webp versions for 87% smaller file sizes!
  const availableImages = [
    'hero-imgs/birds/bald-eagle.optimized.webp',
    'hero-imgs/birds/golden-pheasant.optimized.webp',
    'hero-imgs/birds/parrot.optimized.webp',
    'hero-imgs/devices/T-DECK-PLUS_7.optimized.webp',
    'hero-imgs/devices/m5-lora.optimized.webp',
    'hero-imgs/devices/Panel-Antenna.optimized.webp',
    'hero-imgs/solar/planet5.optimized.webp',
    'hero-imgs/solar/saturn.optimized.webp',
    'hero-imgs/solar/star.optimized.webp',
    'hero-imgs/devices/Wisblock_WisMesh_Pocket_V2_RAK.optimized.webp'
  ];
  shuffledImages = [...availableImages]
    .sort(() => Math.random() - 0.5)
    .slice(0, Math.min(imageCount, availableImages.length));
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="VashonMesh - Community mesh networks connecting neighbors" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    
    <!-- Preload critical assets -->
    <link rel="preload" href="/logo/VashonMesh.svg" as="image" type="image/svg+xml">
    
    <!-- DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="https://gc.zgo.at">
    
    <!-- Critical CSS - most important styles inlined for immediate render -->
    <style is:inline>
      :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f9fafb;
        --text-primary: #111827;
      }
      .dark {
        --bg-primary: #0a0a0a;
        --bg-secondary: #1a1a2e;
        --text-primary: #f9fafb;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        padding: 0;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-family: system-ui, sans-serif;
      }
      .rubik-maps-regular {
        font-family: "Comic Sans MS", "Marker Felt", fantasy, system-ui, sans-serif;
      }
    </style>
    
    <title>{title}</title>
    
    <!-- Allow pages to inject custom SEO meta tags -->
    <slot name="head" />
  </head>
  <body>
    <!-- Floating images container will be injected by JavaScript to avoid LCP calculation -->
    {floatingImages && (
      <script is:inline data-floating-images={JSON.stringify(shuffledImages)}>
        // Create floating container after DOM is ready to prevent LCP issues
        (function() {
          const scriptElement = document.currentScript;
          document.addEventListener('DOMContentLoaded', () => {
            if (!scriptElement) return;
            const container = document.createElement('div');
            container.className = 'floating-container';
            container.style.cssText = 'opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s;';
            const imagesData = scriptElement.getAttribute('data-floating-images');
            if (imagesData) {
              container.setAttribute('data-images', imagesData);
              document.body.appendChild(container);
            }
          });
        })();
      </script>
    )}
    <div class={floatingImages ? "site-wrapper" : ""}>
      <Header />
      {noWrapper ? (
        <slot />
      ) : (
        <div class={`mx-auto px-4 py-8 w-full flex-1 ${floatingImages ? 'page-content' : ''}`} style={`max-width: ${maxWidth}`}>
          {twoColumn ? (
            <div class="grid grid-cols-1 md:grid-cols-[1fr_300px] gap-8 items-start">
              <main class="min-w-0">
                <slot />
              </main>
              <aside class="md:sticky md:top-4">
                <slot name="sidebar" />
              </aside>
            </div>
          ) : (
            <main class="max-w-full">
              <slot />
            </main>
          )}
        </div>
      )}
      <Footer />
    </div>
  </body>
  <!-- Web analytics -->
  <!-- Large script slows page loads...turn on after rest settles down.
  script is:inline data-goatcounter="https://vashonmesh.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script -->
</html>

<style is:global>
  /* Base styles handled in global.css */
  
  /* Layout-specific body styling */
  body {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Responsive breakpoint for two-column layout */
  @media (max-width: 768px) {
    .md\:grid-cols-\[1fr_300px\] {
      grid-template-columns: 1fr;
    }
  }
</style>

{floatingImages && (
  <style is:global>
    /* FloatingImages-specific light mode variables */
    html {
      --bg-primary: rgba(255, 255, 255, 0.85);
      --bg-secondary: rgba(249, 250, 251, 0.85);
      --header-bg: rgba(255, 255, 255, 0.95);
      --footer-bg: rgba(243, 244, 246, 0.95);
    }
    
    /* FloatingImages-specific dark mode overrides */
    html.dark {
      --bg-primary: rgba(10, 10, 10, 0.85);
      --bg-secondary: rgba(26, 26, 46, 0.85);
      --header-bg: rgba(17, 24, 39, 0.95);
      --footer-bg: rgba(31, 41, 55, 0.95);
    }

    /* FloatingImages-specific layout styles */
    html {
      background: #f9fafb;
      transition: background-color 0.3s ease;
      width: 100%;
      overflow-x: hidden;
    }

    html.dark {
      background: #0a0a0a;
    }

    body {
      background: transparent;
      overflow-x: hidden;
      position: relative;
      width: 100%;
      max-width: 100vw;
    }

    .site-wrapper {
      position: relative;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 100vw;
    }

    header {
      position: relative;
      z-index: 100;
    }

    footer {
      position: relative;
      z-index: 100;
      margin-top: auto;
    }

    .page-content {
      flex: 1;
      position: relative;
      z-index: 3;
      pointer-events: none;
    }

    .floating-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 50%, #f9fafb 100%);
      overflow: hidden;
      z-index: 2;
      pointer-events: none;
      transition: background 0.3s ease;
      max-width: 100%;
    }

    html.dark .floating-container {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
    }

    .floating-image {
      position: absolute;
      pointer-events: auto;
      cursor: pointer;
      z-index: 1;
    }

    .floating-image:hover {
      z-index: 200 !important;
    }

    .img-wrapper {
      display: inline-block;
      opacity: 0.5;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      transform: scale(1);
    }

    .floating-image:hover .img-wrapper {
      opacity: 1 !important;
      transform: scale(2.5) rotate(5deg) !important;
    }

    .floating-image img {
      display: block;
      max-width: 80px !important;
      width: 80px !important;
      height: auto !important;
      filter: drop-shadow(0 0 15px rgba(102, 126, 234, 0.3)) drop-shadow(0 0 25px rgba(102, 126, 234, 0.15));
      border-radius: 8px;
      transition: filter 0.3s ease;
    }

    html.dark .floating-image img {
      filter: drop-shadow(0 0 25px rgba(100, 200, 255, 0.45)) drop-shadow(0 0 40px rgba(100, 200, 255, 0.2));
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .floating-image img {
        max-width: 50px !important;
        width: 50px !important;
      }
    }
  </style>
)}

<script>
  // Theme toggle functionality
  function initTheme() {
    const theme = localStorage.getItem('theme') || 'dark';
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }

  // Initialize theme immediately
  initTheme();

  // Add event listener after page loads
  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.getElementById('theme-toggle');
    if (toggle) {
      toggle.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });
    }
  });
</script>

{floatingImages && (
  <script>
    // Dynamic floating image animation system - deferred to avoid blocking render
    // Load images AFTER page is fully loaded to save 8+ MB on initial load
    function initFloatingImages() {
      const container = document.querySelector('.floating-container') as HTMLElement;
      if (!container) return;
      
      // Get image list from data attribute
      const imagesData = container.getAttribute('data-images');
      if (!imagesData) return;
      
      const images = JSON.parse(imagesData);
      if (!images || images.length === 0) return;
      
      // Inject image elements into DOM
      images.forEach((img: string, index: number) => {
        const imageDiv = document.createElement('div');
        imageDiv.className = 'floating-image';
        imageDiv.setAttribute('data-index', index.toString());
        imageDiv.innerHTML = `
          <span class="img-wrapper">
            <img src="/${img}" alt="" width="80" height="80" style="max-width: 80px; width: 80px; height: auto;" loading="lazy" />
          </span>
        `;
        container.appendChild(imageDiv);
      });
      
      const floatingImages = container.querySelectorAll('.floating-image');
      let animationCounter = 0;

      function randomRange(min: number, max: number): number {
        return Math.random() * (max - min) + min;
      }

      function generateKeyframes(index: number): string {
        const keyframeName = `dynamicFloat${animationCounter}_${index}`;
        
        // Random waypoints for more varied paths
        const waypoints = Math.random() > 0.5 ? 4 : 2;
        const percentages = waypoints === 4 ? [0, 25, 50, 75, 100] : [0, 50, 100];
        
        let keyframeString = `@keyframes ${keyframeName} {`;
        
        percentages.forEach(percent => {
          const translateX = percent === 0 
            ? randomRange(-40, -15)
            : percent === 100
              ? randomRange(115, 145)
              : randomRange(percent * 1.2 - 30, percent * 1.2 + 10);
          
          const translateY = randomRange(-20, 20);
          const scale = randomRange(0.7, 1.5);
          const rotate = randomRange(-30, 30);
          
          keyframeString += `
            ${percent}% { transform: translate(${translateX}vw, ${translateY}vh) scale(${scale}) rotate(${rotate}deg); }`;
        });
        
        keyframeString += `\n}`;
        return keyframeString;
      }

      function applyRandomAnimation(img: Element, index: number) {
        const element = img as HTMLElement;
        
        // Generate unique keyframe
        const keyframes = generateKeyframes(index);
        const keyframeName = `dynamicFloat${animationCounter}_${index}`;
        
        // Remove old style tag if exists
        const oldStyle = document.getElementById(`anim-${index}`);
        if (oldStyle) oldStyle.remove();
        
        // Inject new keyframe
        const styleTag = document.createElement('style');
        styleTag.id = `anim-${index}`;
        styleTag.textContent = keyframes;
        document.head.appendChild(styleTag);
        
        // Random starting position
        const top = randomRange(5, 85);
        const left = randomRange(5, 90);
        
        // Random duration between 33-50 seconds
        const duration = randomRange(33, 50);
        
        // Apply styles
        element.style.top = `${top}%`;
        element.style.left = `${left}%`;
        element.style.animationName = keyframeName;
        element.style.animationDuration = `${duration}s`;
        element.style.animationTimingFunction = 'linear';
        element.style.animationIterationCount = '1';
        element.style.animationFillMode = 'forwards';
      }

      function randomizeAllAnimations() {
        animationCounter++;
        floatingImages.forEach((img, index) => {
          applyRandomAnimation(img, index);
        });
      }

      // Listen for animation end on each image
      floatingImages.forEach((img) => {
        img.addEventListener('animationend', () => {
          randomizeAllAnimations();
        });
      });

      // Initial randomization
      randomizeAllAnimations();
      
      // Show floating images after animations start
      setTimeout(() => {
        if (container) {
          container.style.opacity = '1';
          container.style.visibility = 'visible';
          container.style.transition = 'opacity 0.3s ease';
        }
      }, 100);
    }
    
    // Defer animation initialization to load AFTER critical page content
    // This saves 8+ MB on initial page load
    window.addEventListener('load', () => {
      if ('requestIdleCallback' in window) {
        requestIdleCallback(initFloatingImages, { timeout: 3000 });
      } else {
        setTimeout(initFloatingImages, 1000);
      }
    });
  </script>
)}
