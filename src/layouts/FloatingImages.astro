---
import Header from '../components/header.astro';
import Footer from '../components/footer.astro';
import '../styles/global.css';

interface Props {
  title: string;
  images?: string[];
  imageDir?: string;
  imageCount?: number;
}

const { title, images, imageDir = 'hero-imgs', imageCount = 10 } = Astro.props;

let allImages: string[] = [];

if (images) {
  // Use provided images array
  allImages = images;
} else {
  // Dynamically discover all images in the specified directory
  const imageGlob = import.meta.glob('/public/**/*.{png,jpg,jpeg,gif,webp,svg}', { eager: true });
  
  // Extract paths and filter by imageDir
  allImages = Object.keys(imageGlob)
    .map(path => path.replace('/public/', ''))
    .filter(path => path.startsWith(imageDir));
}

// Shuffle and select requested number of images
const shuffledImages = [...allImages]
  .sort(() => Math.random() - 0.5)
  .slice(0, imageCount);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="VashonMesh - Community mesh networks connecting neighbors" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik+Maps&display=swap" rel="stylesheet">

    <title>{title}</title>
  </head>
  <body>
    <div class="floating-container">
      {shuffledImages.map((img, index) => (
        <div class="floating-image" data-index={index}>
          <span class="img-wrapper">
            <img src={`/${img}`} alt={img.replace(/\.(png|jpg|jpeg|gif|webp|svg)$/i, '').split('/').pop()} style="max-width: 80px; width: 80px; height: auto;" />
          </span>
        </div>
      ))}
    </div>
    <div class="site-wrapper">
      <Header />
      <div class="page-content">
        <slot />
      </div>
      <Footer />
    </div>
  </body>
  <script is:inline data-goatcounter="https://vashonmesh.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</html>

<style is:global>
  /* Base styles handled in global.css */
  
  /* FloatingImages-specific dark mode overrides */
  .dark {
    --bg-primary: rgba(10, 10, 10, 0.85);
    --bg-secondary: rgba(26, 26, 46, 0.85);
    --header-bg: rgba(17, 24, 39, 0.95);
    --footer-bg: rgba(31, 41, 55, 0.95);
  }

  /* FloatingImages-specific layout styles */
  html {
    background: #f9fafb; /* Light mode default */
  }

  /* Dark mode via manual toggle */
  :global(.dark) html {
    background: #0a0a0a;
  }

  /* Dark mode via system preference (fallback when no manual preference set) */
  @media (prefers-color-scheme: dark) {
    html:not(.dark):not(.light) {
      background: #0a0a0a;
    }
  }

  body {
    background: transparent;
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  .site-wrapper {
    position: relative;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    position: relative;
    z-index: 100;
  }

  footer {
    position: relative;
    z-index: 100;
    margin-top: auto;
  }

  .page-content {
    flex: 1;
    position: relative;
    z-index: 3;
    pointer-events: none;
  }

  .page-content > * {
    pointer-events: auto;
  }

  code {
    font-family:
      Menlo,
      Monaco,
      Lucida Console,
      Liberation Mono,
      DejaVu Sans Mono,
      Bitstream Vera Sans Mono,
      Courier New,
      monospace;
  }

  .floating-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 50%, #e5e7eb 100%); /* Light mode */
    overflow: hidden;
    z-index: 2;
    pointer-events: none;
  }

  /* Dark mode via manual toggle */
  :global(.dark) .floating-container {
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
  }

  /* Dark mode via system preference (fallback when no manual preference set) */
  @media (prefers-color-scheme: dark) {
    html:not(.dark):not(.light) .floating-container {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
    }
  }

  .floating-image {
    position: absolute;
    pointer-events: auto;
    cursor: pointer;
    z-index: 1;
  }

  .floating-image:hover {
    z-index: 200 !important;
  }

  .img-wrapper {
    display: inline-block;
    opacity: 0.5;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    transform: scale(1);
  }

  .floating-image:hover .img-wrapper {
    opacity: 1 !important;
    transform: scale(2.5) rotate(5deg) !important;
  }

  .floating-image img {
    display: block;
    max-width: 80px !important;
    width: 80px !important;
    height: auto !important;
    filter: drop-shadow(0 0 15px rgba(102, 126, 234, 0.35)) drop-shadow(0 0 25px rgba(102, 126, 234, 0.15)); /* Light mode */
    border-radius: 8px;
  }

  /* Dark mode via manual toggle */
  :global(.dark) .floating-image img {
    filter: drop-shadow(0 0 25px rgba(100, 200, 255, 0.45)) drop-shadow(0 0 40px rgba(100, 200, 255, 0.2));
  }

  /* Dark mode via system preference (fallback when no manual preference set) */
  @media (prefers-color-scheme: dark) {
    html:not(.dark):not(.light) .floating-image img {
      filter: drop-shadow(0 0 25px rgba(100, 200, 255, 0.45)) drop-shadow(0 0 40px rgba(100, 200, 255, 0.2));
    }
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .floating-image img {
      max-width: 50px !important;
      width: 50px !important;
    }
  }
</style>

<script>
  // Theme toggle functionality
  function initTheme() {
    const storedTheme = localStorage.getItem('theme');
    
    if (storedTheme) {
      // Use stored preference
      if (storedTheme === 'dark') {
        document.documentElement.classList.add('dark');
        document.documentElement.classList.remove('light');
      } else {
        document.documentElement.classList.add('light');
        document.documentElement.classList.remove('dark');
      }
    } else {
      // No stored preference, check system preference
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (prefersDark) {
        document.documentElement.classList.add('dark');
        document.documentElement.classList.remove('light');
      } else {
        document.documentElement.classList.add('light');
        document.documentElement.classList.remove('dark');
      }
    }
  }

  // Initialize theme immediately
  initTheme();

  // Add event listener after page loads
  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.getElementById('theme-toggle');
    if (toggle) {
      toggle.addEventListener('click', () => {
        const isDark = document.documentElement.classList.contains('dark');
        if (isDark) {
          document.documentElement.classList.remove('dark');
          document.documentElement.classList.add('light');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.remove('light');
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
      });
    }

    // Dynamic floating image animation system
    const floatingImages = document.querySelectorAll('.floating-image');
    let animationCounter = 0;

    function randomRange(min: number, max: number): number {
      return Math.random() * (max - min) + min;
    }

    function generateKeyframes(index: number): string {
      const keyframeName = `dynamicFloat${animationCounter}_${index}`;
      
      // Random waypoints for more varied paths
      const waypoints = Math.random() > 0.5 ? 4 : 2;
      const percentages = waypoints === 4 ? [0, 25, 50, 75, 100] : [0, 50, 100];
      
      let keyframeString = `@keyframes ${keyframeName} {`;
      
      percentages.forEach(percent => {
        const translateX = percent === 0 
          ? randomRange(-40, -15)
          : percent === 100
            ? randomRange(115, 145)
            : randomRange(percent * 1.2 - 30, percent * 1.2 + 10);
        
        const translateY = randomRange(-20, 20);
        const scale = randomRange(0.7, 1.5);
        const rotate = randomRange(-30, 30);
        
        keyframeString += `
          ${percent}% { transform: translate(${translateX}vw, ${translateY}vh) scale(${scale}) rotate(${rotate}deg); }`;
      });
      
      keyframeString += `\n}`;
      return keyframeString;
    }

    function applyRandomAnimation(img: Element, index: number) {
      const element = img as HTMLElement;
      
      // Generate unique keyframe
      const keyframes = generateKeyframes(index);
      const keyframeName = `dynamicFloat${animationCounter}_${index}`;
      
      // Remove old style tag if exists
      const oldStyle = document.getElementById(`anim-${index}`);
      if (oldStyle) oldStyle.remove();
      
      // Inject new keyframe
      const styleTag = document.createElement('style');
      styleTag.id = `anim-${index}`;
      styleTag.textContent = keyframes;
      document.head.appendChild(styleTag);
      
      // Random starting position
      const top = randomRange(5, 85);
      const left = randomRange(5, 90);
      
      // Random duration between 33-50 seconds
      const duration = randomRange(33, 50);
      
      // Apply styles
      element.style.top = `${top}%`;
      element.style.left = `${left}%`;
      element.style.animationName = keyframeName;
      element.style.animationDuration = `${duration}s`;
      element.style.animationTimingFunction = 'linear';
      element.style.animationIterationCount = '1';
      element.style.animationFillMode = 'forwards';
    }

    function randomizeAllAnimations() {
      animationCounter++;
      floatingImages.forEach((img, index) => {
        applyRandomAnimation(img, index);
      });
    }

    // Listen for animation end on each image
    floatingImages.forEach((img) => {
      img.addEventListener('animationend', () => {
        randomizeAllAnimations();
      });
    });

    // Initial randomization
    randomizeAllAnimations();
  });
</script>
